<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The Gilgamesh Quest</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2b2b2b;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        h1 { margin-bottom: 10px; color: #f1f2f6; }
        #game-container { position: relative; border: 4px solid #8c7ae6; background: #000; box-shadow: 0 0 20px rgba(140,122,230,0.5); border-radius: 4px; }
        canvas { display: block; }

        /* UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display:flex; align-items:center; justify-content:center; z-index:10; }
        .modal { background: rgba(30,30,30,0.98); padding: 25px; border: 2px solid #fff; border-radius: 12px; text-align:center; width:80%; max-width:520px; pointer-events:auto; display:none; box-shadow: 0 10px 25px rgba(0,0,0,0.8); }
        .modal h2 { margin-top:0; color:#e1b12c; font-size:1.5rem; }
        .options { display:flex; flex-direction:column; gap:8px; }
        .options button { width:100%; padding:12px; background:#444; border:1px solid #666; color:#fff; cursor:pointer; border-radius:6px; font-size:1rem; transition:all 0.2s; text-align:left; padding-left:15px; }
        .options button:hover { background:#8c7ae6; border-color:#a29bfe; transform:translateX(5px); }

        #message-area { margin-top:15px; height:20px; color:#ff6b6b; font-weight:bold; font-size:0.9rem; }
        .instructions { margin-top:15px; color:#a4b0be; font-size:0.9rem; }

        #global-message { margin-top:8px; min-height:20px; color:#ffd32a; font-weight:600; font-size:0.95rem; opacity:0; transition:opacity 180ms ease-in-out; pointer-events:none; }
        #global-message.visible { opacity:1; }

        /* Win modal UI */
        #comment-box { width:100%; min-height:90px; margin-top:10px; padding:8px; border-radius:6px; border:1px solid #666; background:#111; color:#fff; resize:vertical; font-family:inherit; font-size:0.95rem; }
        .win-actions { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
        .small-muted { font-size:0.85rem; color:#b2bec3; margin-top:8px; }

        /* Clue UI */
        #clue-block { margin-top:12px; text-align:left; background:#0f1720; padding:10px; border-radius:6px; border:1px solid #333; color:#c7e8ff; display:none; white-space:pre-wrap; font-size:0.95rem; }
        #clue-controls { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    </style>
</head>
<body>

    <h1>The Quest for Gilgamesh</h1>
    
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            <div id="question-modal" class="modal">
                <h2 id="q-title">Gatekeeper's Challenge</h2>
                <p id="q-text">Question goes here...</p>
                <div class="options" id="q-options"></div>
                <div id="message-area"></div>
            </div>

            <div id="win-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="win-title">
                <h2 id="win-title" style="color:#26de81;">You Reached Uruk!</h2>
                <p>Congratulations — you found the real King Gilgamesh.</p>

                <!-- Optional comment (students don't have to leave one) -->
                <textarea id="comment-box" placeholder="Optional: leave a note..." aria-label="Optional comment"></textarea>

                <!-- Clue controls -->
                <div id="clue-controls">
                    <button id="reveal-clue-btn" style="background:#ff6b81; color:#000;">Reveal Clue</button>
                    <button id="show-encrypted-btn" style="background:#a29bfe; color:#000;">Show Encrypted</button>
                    <button id="download-clue-btn" style="background:#74b9ff; color:#000;">Download Clue</button>
                    <button id="done-btn" style="background:#e1b12c; color:#000;">Done</button>
                </div>

                <div id="clue-block" aria-live="polite"></div>
                <div id="win-note" class="small-muted">Tip: Click Reveal Clue when you're ready to see the next hint.</div>
            </div>
        </div>
    </div>

    <p class="instructions">Use <strong>Arrow Keys</strong> to move. Answer questions to unlock red gates.</p>
    <div id="global-message" aria-live="polite"></div>

<script>
    const TILE_SIZE = 40;

    // Map codes: 0 floor, 1 wall, 2 start, 3 end, 4 gate
    const mapLayout = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,0,0,1,0,0,0,0,0,1,0,0,3,1],
        [1,1,1,0,1,0,1,1,1,0,1,0,1,1,1],
        [1,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
        [1,0,1,1,4,1,1,0,1,4,1,1,1,0,1],
        [1,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
        [1,1,1,4,1,1,1,1,1,0,1,1,1,4,1],
        [1,0,0,0,0,0,0,0,0,0,1,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    const ROWS = mapLayout.length;
    const COLS = mapLayout[0].length;

    const questions = [
        { q: "Who wrote the definitive 1939 critical edition of The Sumerian King List?", options: ["Sigmund Freud","Thorkild Jacobsen","Hammurabi","George Smith"], answer:1 },
        { q: "Which artifact is the primary clue for investigating the historical Gilgamesh?", options: ["The Rosetta Stone","The Sumerian King List","The Dead Sea Scrolls","The Code of Ur-Nammu"], answer:1 },
        { q: "Historical evidence suggests Gilgamesh was a contemporary of which King of Kish?", options: ["Sargon","Nebuchadnezzar","Aka","Enkidu"], answer:2 },
        { q: "The name 'Gilgamesh' matches naming conventions from which period?", options: ["The Fara Period","The Roman Empire","The Victorian Era","The Neo-Babylonian Period"], answer:0 },
        { q: "What monumental achievement is the historical Gilgamesh credited with?", options: ["Building the Hanging Gardens","Building the walls of Uruk","Inventing the wheel","Writing the first law code"], answer:1 },
        { q: "Scholars believe the historical Gilgamesh likely ruled around which year?", options: ["1000 BC","2600 BC","500 AD","4000 BC"], answer:1 }
    ];

    // CLUE config: edit CLUE for the hint you want students to receive
    const CLUE = "The key word is Uruk. Enter it into iCollege Quiz: Key to the Ultimate Boon";
    const REQUIRE_COMMENT_BEFORE_CLUE = false; // false = Reveal works without comment

    // Light obfuscation (Caesar)
    function caesarEncrypt(s, shift=3) {
        return s.split('').map(ch => {
            const code = ch.charCodeAt(0);
            if (code >= 65 && code <= 90) return String.fromCharCode(((code-65+shift)%26)+65);
            if (code >= 97 && code <= 122) return String.fromCharCode(((code-97+shift)%26)+97);
            return ch;
        }).join('');
    }
    function caesarDecrypt(s, shift=3){ return caesarEncrypt(s, 26-(shift%26)); }
    const encryptedClue = caesarEncrypt(CLUE, 3);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = COLS * TILE_SIZE;
    canvas.height = ROWS * TILE_SIZE;

    const player = { x:1, y:1, color:'#4b7bec' };
    let currentGate = null;
    let usedQuestions = [];
    let inputLocked = false;

    const globalMessageEl = document.getElementById('global-message');
    let globalMessageTimer = null;

    // Win elements
    const winModal = document.getElementById('win-modal');
    const commentBox = document.getElementById('comment-box');
    const revealClueBtn = document.getElementById('reveal-clue-btn');
    const showEncryptedBtn = document.getElementById('show-encrypted-btn');
    const downloadClueBtn = document.getElementById('download-clue-btn');
    const doneBtn = document.getElementById('done-btn');
    const clueBlock = document.getElementById('clue-block');

    function initGame(){
        for (let r=0;r<ROWS;r++){
            for (let c=0;c<COLS;c++){
                if (mapLayout[r][c]===2){ player.x=c; player.y=r; break; }
            }
        }
        draw();
    }

    function gatesRemaining(){
        let count=0;
        for (let r=0;r<ROWS;r++) for (let c=0;c<COLS;c++) if (mapLayout[r][c]===4) count++;
        return count;
    }

    function showGlobalMessage(text,duration=1600){
        clearGlobalMessage();
        globalMessageEl.textContent = text;
        globalMessageEl.classList.add('visible');
        if (duration>0) globalMessageTimer = setTimeout(clearGlobalMessage,duration);
    }
    function clearGlobalMessage(){ if(globalMessageTimer){clearTimeout(globalMessageTimer); globalMessageTimer=null;} globalMessageEl.classList.remove('visible'); globalMessageEl.textContent=''; }

    document.addEventListener('keydown', (e) => {
        if (inputLocked) return;
        if (document.getElementById('question-modal').style.display==='block') return;
        if (winModal.style.display==='block') return;

        let nextX = player.x, nextY = player.y;
        if (e.key==='ArrowUp') nextY--;
        if (e.key==='ArrowDown') nextY++;
        if (e.key==='ArrowLeft') nextX--;
        if (e.key==='ArrowRight') nextX++;

        if (!mapLayout[nextY] || mapLayout[nextY][nextX]===undefined) return;
        const tile = mapLayout[nextY][nextX];

        if (tile===1) return;
        if (tile===4) { triggerQuestion(nextX,nextY); return; }
        if (tile===3){
            const remaining = gatesRemaining();
            if (remaining>0){ showGlobalMessage(`You must unlock ${remaining} gate(s) before reaching Uruk.`); return; }
            movePlayer(nextX,nextY); showWin(); return;
        }
        movePlayer(nextX,nextY);
    });

    function movePlayer(x,y){ player.x=x; player.y=y; draw(); }

    function triggerQuestion(x,y){
        currentGate = {x,y};
        inputLocked = true;
        if (usedQuestions.length >= questions.length) usedQuestions = [];
        let qIndex;
        do { qIndex = Math.floor(Math.random()*questions.length); } while (usedQuestions.includes(qIndex) && usedQuestions.length < questions.length);
        usedQuestions.push(qIndex);
        showModal(questions[qIndex]);
    }

    function showModal(qObj){
        const modal = document.getElementById('question-modal');
        const title = document.getElementById('q-title');
        const text = document.getElementById('q-text');
        const optsDiv = document.getElementById('q-options');
        const msg = document.getElementById('message-area');
        title.innerText = "The Gatekeeper Asks...";
        text.innerText = qObj.q;
        optsDiv.innerHTML = ""; msg.innerText = "";
        qObj.options.forEach((opt,idx)=>{
            const btn = document.createElement('button');
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(idx, qObj.answer);
            optsDiv.appendChild(btn);
        });
        modal.style.display = 'block';
    }

    function closeModal(){ document.getElementById('question-modal').style.display='none'; inputLocked=false; }

    function checkAnswer(selected, correct){
        const msg = document.getElementById('message-area');
        if (selected === correct){
            msg.style.color = "#26de81";
            msg.innerText = "Correct! The gate opens.";
            setTimeout(()=>{
                if (currentGate){ mapLayout[currentGate.y][currentGate.x]=0; movePlayer(currentGate.x,currentGate.y); currentGate=null; clearGlobalMessage(); }
                closeModal();
            },600);
        } else {
            msg.style.color = "#ff6b6b"; msg.innerText = "Incorrect! Access denied.";
            setTimeout(closeModal,900);
        }
    }

    function showWin(){
        // do not auto-reveal — keep reveal button
        clueBlock.style.display = 'none';
        clueBlock.textContent = '';
        commentBox.value = ''; // optional: leave blank
        winModal.style.display = 'block';
    }

    // Reveal clue — respects REQUIRE_COMMENT_BEFORE_CLUE
    revealClueBtn.addEventListener('click', () => {
        if (REQUIRE_COMMENT_BEFORE_CLUE){
            const text = commentBox.value.trim();
            if (!text){ clueBlock.textContent = 'Please add a comment before revealing the clue.'; clueBlock.style.display='block'; return; }
        }
        clueBlock.textContent = caesarDecrypt(encryptedClue,3);
        clueBlock.style.display = 'block';
    });

    // Show encrypted clue for puzzle effect
    showEncryptedBtn.addEventListener('click', () => { clueBlock.textContent = encryptedClue; clueBlock.style.display = 'block'; });

    // Download clue
    downloadClueBtn.addEventListener('click', () => {
        const plain = caesarDecrypt(encryptedClue,3);
        const filename = `gilgamesh_clue_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
        const blob = new Blob([plain], { type:'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    doneBtn.addEventListener('click', ()=>{ winModal.style.display='none'; });

    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && winModal.style.display==='block') winModal.style.display='none'; });

    function draw(){
        ctx.fillStyle="#2b2b2b"; ctx.fillRect(0,0,canvas.width,canvas.height);
        for (let r=0;r<ROWS;r++){
            for (let c=0;c<COLS;c++){
                const tile = mapLayout[r][c];
                const x = c*TILE_SIZE, y = r*TILE_SIZE;
                if (tile===1){ ctx.fillStyle="#57606f"; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE); ctx.strokeStyle="#2f3542"; ctx.lineWidth=2; ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE); }
                else if (tile===3){ ctx.fillStyle="#26de81"; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE); ctx.fillStyle="#000"; ctx.font="bold 10px Arial"; ctx.fillText("URUK", x+5, y+24); }
                else if (tile===4){ ctx.fillStyle="#ff4757"; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE); ctx.fillStyle="#fff"; ctx.font="bold 20px Arial"; ctx.fillText("?", x+13, y+27); ctx.fillStyle="rgba(0,0,0,0.2)"; ctx.fillRect(x+6,y+6,TILE_SIZE-12,6); }
                else { ctx.fillStyle="#333"; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE); ctx.strokeStyle="#3a3a3a"; ctx.lineWidth=1; ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE); }
            }
        }
        ctx.fillStyle = player.color; ctx.beginPath();
        const cx = player.x*TILE_SIZE + TILE_SIZE/2, cy = player.y*TILE_SIZE + TILE_SIZE/2;
        ctx.arc(cx, cy, TILE_SIZE/3, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.stroke();
    }

    // init
    initGame();
</script>
</body>
</html>
